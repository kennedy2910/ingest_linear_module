<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>{{ request.app.title }} - Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    body { padding: 20px; }
    code { background: #f6f6f6; padding: 2px 6px; border-radius: 6px; }
    .small-muted { color: #666; font-size: .9rem; }
  </style>
</head>
<body>
<div class="container">
  <h1 class="mb-1">Central-Nex</h1>
  <div class="small-muted mb-4">Curadoria de canais • Providers (pacotes) • Edges (CDN) • API Key por Edge</div>

  <div class="row g-4">
    <div class="col-lg-6">
      <div class="card">
        <div class="card-header"><b>Providers (Pacotes)</b></div>
        <div class="card-body">
          <form class="row g-2" method="post" action="/admin/providers/create">
            <div class="col-md-3"><input class="form-control" name="provider_id" placeholder="prov-001" required></div>
            <div class="col-md-4"><input class="form-control" name="name" placeholder="Esportes" required></div>
            <div class="col-md-5"><input class="form-control" name="description" placeholder="descrição (opcional)"></div>
            <div class="col-12"><button class="btn btn-primary btn-sm">Criar Provider</button></div>
          </form>

          <hr>
          <table class="table table-sm align-middle">
            <thead><tr><th>ID</th><th>Nome</th><th></th></tr></thead>
            <tbody>
            {% for p in providers %}
              <tr>
                <td><code>{{ p.provider_id }}</code></td>
                <td>{{ p.name }}</td>
                <td class="text-end">
                  <form method="post" action="/admin/providers/delete" onsubmit="return confirm('Deletar provider {{p.provider_id}}? Isso remove canais e permissões relacionadas.');">
                    <input type="hidden" name="provider_id" value="{{p.provider_id}}">
                    <button class="btn btn-outline-danger btn-sm">Excluir</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="card mt-4">
        <div class="card-header"><b>Canais</b></div>
        <div class="card-body">
          <form class="row g-2" method="post" action="/admin/channels/create">
  <div class="col-md-4">
    <label class="form-label mb-1">Nome do Canal</label>
    <input class="form-control" name="name" placeholder="ESPN" required>
  </div>
  <div class="col-md-3">
    <label class="form-label mb-1">Categoria</label>
    <input class="form-control" name="category" placeholder="Esporte" required>
  </div>
  <div class="col-md-2">
    <label class="form-label mb-1">Numero</label>
    <input class="form-control" name="channel_number" placeholder="004" required>
  </div>
  <div class="col-md-3">
    <label class="form-label mb-1">Provider (Pacote)</label>
    <select class="form-select" name="provider_id" required>
      {% for p in providers %}
        <option value="{{p.provider_id}}">{{p.name}} ({{p.provider_id}})</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label mb-1">Tipo (kind)</label>
    <select class="form-select" name="kind">
      <option value="auto">auto (inferir)</option>
      <option value="hls">hls</option>
      <option value="youtube">youtube</option>
      <option value="youtube_linear">youtube_linear</option>
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label mb-1">Ordem</label>
    <input class="form-control" name="sort_order" type="number" value="100">
  </div>
  <div class="col-md-6">
    <label class="form-label mb-1">Schedule Start (UTC)</label>
    <input class="form-control" name="schedule_start" placeholder="2026-01-31T00:00:00Z">
  </div>
  <div class="col-md-12">
    <label class="form-label mb-1">Source URL</label>
    <input class="form-control" name="source_url" placeholder="https://... (HLS) ou https://youtube.com/... (para youtube_linear use o 1o video)">
  </div>
  <div class="col-12 d-flex gap-2 align-items-center">
    <input type="hidden" name="is_active" value="1">
    <button class="btn btn-primary btn-sm">Criar Canal</button>
    <span class="small-muted">O app IPTV agrupa por provider; categoria e para display/filtro.</span>
  </div>
</form>

          <hr>
          <table class="table table-sm align-middle">
            <thead><tr><th>Canal</th><th>Provider</th><th>Kind / Schedule</th><th>Source</th><th></th></tr></thead>
            <tbody>
            {% for c in channels %}
              <tr>
                <td><b>{{ c.channel_number }} - {{ c.name }}</b><div class="small-muted">Categoria: <code>{{ c.category }}</code> • ID interno: <code>{{ c.id }}</code></div></td>
                <td>{{ c.provider_name }}<div class="small-muted"><code>{{ c.provider_id }}</code></div></td>
                <td><code>{{ c.kind }}</code><div class="small-muted">{{ c.schedule_start or "" }}</div></td>
                <td style="max-width: 320px; overflow:hidden; text-overflow: ellipsis; white-space: nowrap;"><code>{{ c.source_url }}</code></td>
                <td class="text-end">
                  <form method="post" action="/admin/channels/delete" onsubmit="return confirm('Excluir canal {{c.channel_number }} - {{c.name}}?');">
                    <input type="hidden" name="id" value="{{c.id}}">
                    <button class="btn btn-outline-danger btn-sm">Excluir</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="card mt-4">
        <div class="card-header"><b>Programacao (YouTube Linear)</b></div>
        <div class="card-body">
          <form class="row g-2" method="post" action="/admin/channel-items/create">
            <div class="col-md-5">
              <label class="form-label mb-1">Canal</label>
              <select class="form-select" name="channel_id" required>
                {% for c in channels %}
                  <option value="{{c.id}}">{{ c.channel_number }} - {{ c.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label mb-1">Posicao</label>
              <input class="form-control" name="position" type="number" value="1">
            </div>
            <div class="col-md-2">
              <label class="form-label mb-1">Tipo</label>
              <select class="form-select" name="type">
                <option value="video">video</option>
                <option value="ad">ad</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label mb-1">Duracao (segundos)</label>
              <input class="form-control" name="duration" type="number" min="1" placeholder="Ex: 3600">
            </div>
            <div class="col-md-8">
              <label class="form-label mb-1">URL (apenas video)</label>
              <input class="form-control" name="url" placeholder="https://youtube.com/...">
            </div>
            <div class="col-12 d-flex gap-2 align-items-center">
              <button class="btn btn-primary btn-sm">Adicionar Item</button>
              <span class="small-muted">Para ads, se duracao ficar vazia usamos 30s. Para video, informe URL do YouTube e duracao manual.</span>
            </div>
          </form>

          <hr>
          <table class="table table-sm align-middle">
            <thead><tr><th>Canal</th><th>Pos</th><th>Tipo</th><th>Duracao</th><th>Titulo</th><th>URL</th><th></th></tr></thead>
            <tbody>
            {% for it in channel_items %}
              <tr>
                <td><b>{{ it.channel_number }} - {{ it.channel_name }}</b><div class="small-muted">ID: <code>{{ it.channel_id }}</code></div></td>
                <td><code>{{ it.position }}</code></td>
                <td><code>{{ it.type }}</code></td>
                <td><code>{{ it.duration }}</code></td>
                <td style="max-width: 220px; overflow:hidden; text-overflow: ellipsis; white-space: nowrap;"><code>{{ it.title or '' }}</code></td>
                <td style="max-width: 320px; overflow:hidden; text-overflow: ellipsis; white-space: nowrap;"><code>{{ it.url }}</code></td>
                <td class="text-end">
                  <form method="post" action="/admin/channel-items/delete" onsubmit="return confirm('Excluir item ID {{it.id}}?');">
                    <input type="hidden" name="id" value="{{it.id}}">
                    <button class="btn btn-outline-danger btn-sm">Excluir</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card">
        <div class="card-header"><b>Edges (CDN)</b></div>
        <div class="card-body">
          <form class="row g-2" method="post" action="/admin/edges/create">
            <div class="col-md-3"><input class="form-control" name="edge_id" placeholder="edge-001" required></div>
            <div class="col-md-4"><input class="form-control" name="name" placeholder="Edge Lisboa" required></div>
            <div class="col-md-5"><input class="form-control" name="hls_base_url" placeholder="http://EDGE_IP:8080/hls" required></div>
            <div class="col-12"><button class="btn btn-primary btn-sm">Criar Edge + API Key</button></div>
          </form>

          <hr>
          <table class="table table-sm align-middle">
            <thead><tr><th>Edge</th><th>API Key</th><th>HLS Base</th><th></th></tr></thead>
            <tbody>
            {% for e in edges %}
              <tr>
                <td>
                  <b>{{ e.name }}</b>
                  <div class="small-muted"><code>{{ e.edge_id }}</code></div>
                  <div class="mt-1"><a href="/admin/edges/{{e.edge_id}}/providers">Permissões (Providers)</a></div>
                </td>
                <td style="max-width: 240px; overflow:hidden; text-overflow: ellipsis; white-space: nowrap;">
                  <code>{{ e.api_key }}</code>
                  <div class="small-muted mt-1">
                    Playlist IPTV: <code>/iptv/edge.m3u?api_key={{e.api_key}}</code>
                  </div>
                </td>
                <td style="max-width: 220px; overflow:hidden; text-overflow: ellipsis; white-space: nowrap;"><code>{{ e.hls_base_url }}</code></td>
                <td class="text-end">
                  <form class="mb-2" method="post" action="/admin/edges/rotate_key" onsubmit="return confirm('Girar API key do edge {{e.edge_id}}? A antiga para de funcionar.');">
                    <input type="hidden" name="edge_id" value="{{e.edge_id}}">
                    <button class="btn btn-outline-secondary btn-sm">Girar Key</button>
                  </form>
                  <form method="post" action="/admin/edges/delete" onsubmit="return confirm('Excluir edge {{e.edge_id}}?');">
                    <input type="hidden" name="edge_id" value="{{e.edge_id}}">
                    <button class="btn btn-outline-danger btn-sm">Excluir</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>

          <hr>
          <div class="small-muted">
            <b>Como o Edge puxa a lista:</b><br>
            <code>GET /api/edge/channels</code> com header <code>X-API-KEY</code>.<br>
            Retorna somente canais dos providers permitidos (edge → providers).
          </div>
        </div>
      </div>

      <div class="card mt-4">
        <div class="card-header"><b>Teste rápido</b></div>
        <div class="card-body">
<pre class="mb-0"><code>curl -H "X-API-KEY: edge_xxx" http://CENTRAL_IP:9000/api/edge/channels
curl "http://CENTRAL_IP:9000/iptv/edge.m3u?api_key=edge_xxx"</code></pre>
        </div>
      </div>
    </div>

  </div>
</div>
</body>
</html>
